name: Build & Release MP4Box Bundle

# .github/workflows/release-mp4box-bundle.yml @ v0.1.5
#
# v0.1.5 changes vs v0.1.4:
# - When publish=true:
#   1) Publish a versioned release to tag_name (assets keep versioned filenames)
#   2) ALSO publish/update a stable "latest" release/tag: mp4box-bundle-latest
#      with FIXED asset names for permanent download URLs:
#        - mp4box-bundle-linux-x86_64.tar.zst
#        - mp4box-bundle-linux-x86_64.tar.zst.sha256
#        - metadata.txt
#
# Notes:
# - Build base: ubuntu-22.04 (glibc 2.35). Bundle is tested on ubuntu-22.04 and ubuntu-24.04.
# - We intentionally exclude glibc/loader libs (libc, ld-linux, libpthread, libm, libdl, librt, libresolv, libutil).
# - `gh` commands use explicit --repo and --target to avoid requiring a local .git checkout.

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Versioned release tag name (e.g. mp4box-bundle-v0.1.5-rev1). Required if publish=true."
        required: false
        default: "mp4box-bundle-v0.1.5-rev1"
        type: string
      publish:
        description: "Publish to GitHub Release (creates/updates release assets). Also updates mp4box-bundle-latest."
        required: true
        default: false
        type: boolean
      bundle_rev:
        description: "Bundle revision label (for filename/metadata only), e.g. 1/2/3"
        required: true
        default: "1"
        type: string

permissions:
  contents: write

jobs:
  build:
    name: build-bundle
    runs-on: ubuntu-22.04
    outputs:
      asset_basename: ${{ steps.meta.outputs.asset_basename }}
      asset_file: ${{ steps.meta.outputs.asset_file }}
      sha_file: ${{ steps.meta.outputs.sha_file }}
      meta_file: ${{ steps.meta.outputs.meta_file }}

    steps:
      - name: Install build deps (gpac + tools)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gpac gpac-modules-base patchelf zstd

      - name: Build MP4Box bundle
        id: meta
        run: |
          set -euo pipefail

          MP4BOX="$(command -v MP4Box)"
          echo "MP4Box path: $MP4BOX"

          GPAC_PKG_VER="$(dpkg-query -W -f='${Version}\n' gpac || true)"
          GPAC_PKG_VER_SAFE="$(printf '%s' "$GPAC_PKG_VER" | LC_ALL=C sed 's/[^A-Za-z0-9._+\-]/_/g')"

          GLIBC_VER="$(ldd --version 2>/dev/null | head -n 1 | awk '{print $NF}')"
          ARCH="$(uname -m)"
          UBUNTU_VER="$(. /etc/os-release && echo "$VERSION_ID")"

          BUNDLE_ROOT="$RUNNER_TEMP/mp4box-bundle"
          BIN="$BUNDLE_ROOT/bin"
          LIB="$BUNDLE_ROOT/lib"
          mkdir -p "$BIN" "$LIB"

          cp -av "$MP4BOX" "$BIN/MP4Box.bin"

          should_exclude() {
            local base="$1"
            case "$base" in
              libc.so.*|ld-linux*|ld-*.so*|libpthread.so.*|libm.so.*|libdl.so.*|librt.so.*|libresolv.so.*|libutil.so.*)
                return 0
                ;;
              *)
                return 1
                ;;
            esac
          }

          copy_lib() {
            local p="$1"
            [[ -z "$p" ]] && return 0
            if [[ ! -e "$p" ]]; then
              echo "::warning::lib not found on disk: $p"
              return 1
            fi

            local base real real_base
            base="$(basename "$p")"

            if should_exclude "$base"; then
              return 0
            fi

            real="$(readlink -f "$p" || true)"
            [[ -z "$real" || ! -e "$real" ]] && real="$p"
            real_base="$(basename "$real")"

            if [[ ! -e "$LIB/$real_base" ]]; then
              cp -av "$real" "$LIB/"
            fi

            if [[ "$base" != "$real_base" ]]; then
              ln -sf "$real_base" "$LIB/$base"
            fi

            return 0
          }

          echo "::group::ldd MP4Box.bin (system env)"
          ldd "$BIN/MP4Box.bin" || true
          echo "::endgroup::"

          missing=0
          while IFS= read -r line; do
            if echo "$line" | grep -q "not found"; then
              echo "::error::Missing dependency: $line"
              missing=1
              continue
            fi

            p="$(echo "$line" | awk '{for(i=1;i<=NF;i++) if($i ~ /^\//) {print $i; exit}}')"
            [[ -z "$p" ]] && continue
            echo "$p" | grep -q "linux-vdso" && continue

            if ! copy_lib "$p"; then
              missing=1
            fi
          done < <(ldd "$BIN/MP4Box.bin" || true)

          if [[ "$missing" -ne 0 ]]; then
            echo "::error::Some dependencies were missing/unpackable."
            exit 1
          fi

          MOD_SRC=""
          for d in /usr/lib/*/gpac /usr/lib/*/gpac/modules; do
            [[ -d "$d" ]] && { MOD_SRC="$d"; break; }
          done
          if [[ -z "$MOD_SRC" ]]; then
            MOD_SRC="$(dpkg -L gpac-modules-base 2>/dev/null | grep -E '/gpac(/modules)?$' | head -n 1 || true)"
          fi

          if [[ -n "$MOD_SRC" && -d "$MOD_SRC" ]]; then
            echo "::notice::Bundling GPAC modules from: $MOD_SRC"
            mkdir -p "$LIB/gpac"
            cp -a "$MOD_SRC"/. "$LIB/gpac/" || true
          else
            echo "::warning::Could not locate GPAC modules directory to bundle."
          fi

          # Prefer bundled libs without LD_LIBRARY_PATH
          patchelf --set-rpath '$ORIGIN/../lib' "$BIN/MP4Box.bin" || true

          # Wrapper (kept for safety)
          cat > "$BIN/MP4Box" <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$DIR/../lib:${LD_LIBRARY_PATH:-}"
          exec "$DIR/MP4Box.bin" "$@"
          SH
          chmod +x "$BIN/MP4Box"

          # Metadata
          META="$RUNNER_TEMP/metadata.txt"
          {
            echo "bundle_rev=${{ inputs.bundle_rev }}"
            echo "build_ubuntu=${UBUNTU_VER}"
            echo "arch=${ARCH}"
            echo "glibc=${GLIBC_VER}"
            echo "gpac_pkg_version=${GPAC_PKG_VER}"
            echo "mp4box_path=${MP4BOX}"
            echo "build_time_utc=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          } > "$META"

          # Package (versioned filename)
          ASSET_BASENAME="mp4box-gpac_${GPAC_PKG_VER_SAFE}-linux_${ARCH}-ubuntu${UBUNTU_VER}-glibc${GLIBC_VER}-rev${{ inputs.bundle_rev }}"
          ASSET_FILE="${ASSET_BASENAME}.tar.zst"
          SHA_FILE="${ASSET_FILE}.sha256"

          tar --zstd -cf "$RUNNER_TEMP/$ASSET_FILE" -C "$BUNDLE_ROOT" .
          (cd "$RUNNER_TEMP" && sha256sum "$ASSET_FILE" > "$SHA_FILE")

          echo "asset_basename=$ASSET_BASENAME" >> "$GITHUB_OUTPUT"
          echo "asset_file=$ASSET_FILE" >> "$GITHUB_OUTPUT"
          echo "sha_file=$SHA_FILE" >> "$GITHUB_OUTPUT"
          echo "meta_file=$(basename "$META")" >> "$GITHUB_OUTPUT"

      - name: Upload build artifacts (tar.zst + sha256 + metadata)
        uses: actions/upload-artifact@v4
        with:
          name: mp4box-bundle-build
          path: |
            ${{ runner.temp }}/${{ steps.meta.outputs.asset_file }}
            ${{ runner.temp }}/${{ steps.meta.outputs.sha_file }}
            ${{ runner.temp }}/${{ steps.meta.outputs.meta_file }}
          if-no-files-found: error

  test:
    name: test-bundle-${{ matrix.os }}
    needs: build
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mp4box-bundle-build
          path: ${{ runner.temp }}/mp4box-bundle-build

      - name: Extract + run checks
        run: |
          set -euo pipefail
          cd "${{ runner.temp }}/mp4box-bundle-build"

          ls -la
          sha256sum -c "${{ needs.build.outputs.sha_file }}"

          BUNDLE="$HOME/.local/mp4box-bundle"
          rm -rf "$BUNDLE"
          mkdir -p "$BUNDLE"

          tar --zstd -xf "${{ needs.build.outputs.asset_file }}" -C "$BUNDLE"

          export PATH="$BUNDLE/bin:$PATH"
          echo "$BUNDLE/bin" >> "$GITHUB_PATH"
          export LD_LIBRARY_PATH="$BUNDLE/lib:${LD_LIBRARY_PATH:-}"

          command -v MP4Box
          MP4Box -version | head -n 3

          echo "::group::ldd MP4Box.bin (realistic env)"
          ldd "$BUNDLE/bin/MP4Box.bin" | tee /tmp/ldd-mp4box.txt
          echo "::endgroup::"
          ! grep -q "not found" /tmp/ldd-mp4box.txt

  release:
    name: release
    needs: [build, test]
    if: ${{ inputs.publish }}
    runs-on: ubuntu-22.04

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: mp4box-bundle-build
          path: ${{ runner.temp }}/mp4box-bundle-build

      - name: Create/Update GitHub Releases (versioned + latest) and upload assets
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          cd "${{ runner.temp }}/mp4box-bundle-build"

          TAG_VER="${{ inputs.tag_name }}"
          if [[ -z "$TAG_VER" ]]; then
            echo "::error::tag_name is required when publish=true"
            exit 1
          fi

          TAG_LATEST="mp4box-bundle-latest"

          ASSET_VER="${{ needs.build.outputs.asset_file }}"
          SHA_VER="${{ needs.build.outputs.sha_file }}"
          META="metadata.txt"

          # Prepare FIXED filenames for stable latest URLs
          FIX_ASSET="mp4box-bundle-linux-x86_64.tar.zst"
          FIX_SHA="${FIX_ASSET}.sha256"

          cp -f "$ASSET_VER" "$FIX_ASSET"
          sha256sum "$FIX_ASSET" > "$FIX_SHA"

          make_notes() {
            local out="$1"
            local kind="$2"
            local tag="$3"
            local asset1="$4"
            local asset2="$5"
            {
              echo "MP4Box (GPAC) bundle build."
              echo ""
              echo "Release kind: $kind"
              echo "Tag: $tag"
              echo ""
              echo "Assets:"
              echo "- $asset1"
              echo "- $asset2"
              echo "- $META"
              echo ""
              echo "Notes:"
              echo "- Built on ubuntu-22.04 via apt (gpac + gpac-modules-base)."
              echo "- Bundles MP4Box + shared libs (excluding glibc/loader) + GPAC modules."
              echo "- Intended for use by Manzana auto-tooling bootstrap."
            } > "$out"
          }

          ensure_release() {
            local tag="$1"
            local title="$2"
            local notes_file="$3"

            if gh release view "$tag" --repo "$GH_REPO" >/dev/null 2>&1; then
              gh release edit "$tag" --repo "$GH_REPO" --title "$title" --notes-file "$notes_file"
            else
              gh release create "$tag" --repo "$GH_REPO" --target "$GITHUB_SHA" --title "$title" --notes-file "$notes_file"
            fi
          }

          # --- Versioned release (immutable-ish assets) ---
          NOTES_VER="${{ runner.temp }}/release-notes-versioned.txt"
          make_notes "$NOTES_VER" "versioned" "$TAG_VER" "$ASSET_VER" "$SHA_VER"
          ensure_release "$TAG_VER" "MP4Box Bundle (${TAG_VER})" "$NOTES_VER"

          gh release upload "$TAG_VER" --repo "$GH_REPO" \
            "$ASSET_VER" \
            "$SHA_VER" \
            "$META" \
            --clobber

          # --- Latest release (stable URLs + fixed names) ---
          NOTES_LATEST="${{ runner.temp }}/release-notes-latest.txt"
          make_notes "$NOTES_LATEST" "latest (stable URLs)" "$TAG_LATEST" "$FIX_ASSET" "$FIX_SHA"
          ensure_release "$TAG_LATEST" "MP4Box Bundle (latest)" "$NOTES_LATEST"

          gh release upload "$TAG_LATEST" --repo "$GH_REPO" \
            "$FIX_ASSET" \
            "$FIX_SHA" \
            "$META" \
            --clobber
