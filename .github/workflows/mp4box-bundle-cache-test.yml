name: MP4Box Bundle Cache Test

# .github/workflows/mp4box-bundle-cache-test.yml @ v0.1.4
#
# Purpose:
# - Build a portable-ish MP4Box (gpac) bundle on cache miss.
# - On cache hit, skip apt install entirely (near 0 seconds).
# - Run on a matrix of ubuntu-latest and ubuntu-22.04 to compare stability.
#
# v0.1.4 changes vs v0.1.3:
# - Cache key now includes real Ubuntu VERSION_ID (e.g., 22.04/24.04), not ubuntu-latest alias.
#   This prevents incorrect cache reuse when ubuntu-latest upgrades (e.g., 24.04 -> 26.04).

on:
  workflow_dispatch:
    inputs:
      bundle_rev:
        description: "Bundle cache revision (bump to rebuild cache), e.g. 1/2/3"
        required: true
        default: "1"
        type: string
      upload_bundle:
        description: "Upload gpac-bundle as artifact (for inspection)"
        required: true
        default: false
        type: boolean

jobs:
  test:
    name: test-${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - ubuntu-22.04

    steps:
      - name: Show system info (OS/glibc/runner)
        run: |
          set -euo pipefail
          echo "=== uname ==="
          uname -a || true
          echo "=== /etc/os-release ==="
          cat /etc/os-release || true
          echo "=== glibc (ldd) ==="
          (ldd --version 2>/dev/null | head -n 2) || true
          echo "=== runner image ==="
          echo "ImageOS=$ImageOS"
          echo "ImageVersion=$ImageVersion"
          echo "RunnerOS=$RUNNER_OS"
          echo "RunnerArch=$RUNNER_ARCH"
          echo "=== PATH ==="
          echo "$PATH"

      - name: Detect Ubuntu VERSION_ID (for stable cache key)
        run: |
          set -euo pipefail
          . /etc/os-release
          echo "UBUNTU_VERSION_ID=$VERSION_ID" >> "$GITHUB_ENV"
          echo "Detected UBUNTU_VERSION_ID=$VERSION_ID"

      - name: Cache MP4Box bundle
        id: cache-gpac
        uses: actions/cache@v4
        with:
          path: ~/.local/gpac-bundle
          key: gpac-bundle-${{ runner.os }}-ubuntu${{ env.UBUNTU_VERSION_ID }}-${{ runner.arch }}-rev${{ inputs.bundle_rev }}

      - name: Build gpac bundle on cache miss (apt + ldd bundle + gpac modules)
        if: ${{ steps.cache-gpac.outputs.cache-hit != 'true' }}
        run: |
          set -euo pipefail

          echo "::notice::Cache miss -> installing gpac via apt and building bundle..."

          sudo apt-get update
          sudo apt-get install -y gpac

          MP4BOX_PATH="$(command -v MP4Box)"
          echo "MP4Box path: $MP4BOX_PATH"
          MP4Box -version || true

          BUNDLE="$HOME/.local/gpac-bundle"
          BIN="$BUNDLE/bin"
          LIB="$BUNDLE/lib"
          mkdir -p "$BIN" "$LIB"

          # Copy the real binary
          cp -av "$MP4BOX_PATH" "$BIN/MP4Box.bin"

          # Helper: copy lib real file + create symlink for requested SONAME if needed
          copy_lib() {
            local p="$1"
            if [[ -z "$p" ]]; then
              return 0
            fi
            if [[ ! -e "$p" ]]; then
              echo "::warning::lib not found on disk: $p"
              return 1
            fi
            local base
            base="$(basename "$p")"
            local real
            real="$(readlink -f "$p" || true)"
            if [[ -z "$real" || ! -e "$real" ]]; then
              real="$p"
            fi
            local real_base
            real_base="$(basename "$real")"

            if [[ ! -e "$LIB/$real_base" ]]; then
              cp -av "$real" "$LIB/"
            fi

            if [[ "$base" != "$real_base" ]]; then
              ln -sf "$real_base" "$LIB/$base"
            fi
          }

          echo "::group::ldd MP4Box.bin (system env)"
          ldd "$BIN/MP4Box.bin" || true
          echo "::endgroup::"

          missing=0
          while IFS= read -r line; do
            if echo "$line" | grep -q "not found"; then
              echo "::error::Missing dependency: $line"
              missing=1
              continue
            fi

            p="$(echo "$line" | awk '{for(i=1;i<=NF;i++) if($i ~ /^\//) {print $i; exit}}')"
            if [[ -z "$p" ]]; then
              continue
            fi

            if echo "$p" | grep -q "linux-vdso"; then
              continue
            fi

            if ! copy_lib "$p"; then
              missing=1
            fi
          done < <(ldd "$BIN/MP4Box.bin" || true)

          if [[ "$missing" -ne 0 ]]; then
            echo "::error::Some dependencies were missing/unpackable."
            exit 1
          fi

          # --- Bundle GPAC modules directory into $LIB/gpac ---
          MOD_SRC=""
          for d in /usr/lib/*/gpac /usr/lib/*/gpac/modules; do
            if [[ -d "$d" ]]; then
              MOD_SRC="$d"
              break
            fi
          done
          if [[ -z "$MOD_SRC" ]]; then
            MOD_SRC="$(dpkg -L gpac 2>/dev/null | grep -E '/gpac(/modules)?$' | head -n 1 || true)"
          fi

          if [[ -n "$MOD_SRC" && -d "$MOD_SRC" ]]; then
            echo "::notice::Bundling GPAC modules from: $MOD_SRC"
            mkdir -p "$LIB/gpac"
            cp -a "$MOD_SRC"/. "$LIB/gpac/" || true
          else
            echo "::warning::Could not locate GPAC modules directory to bundle (this may only affect plugin-based features)."
          fi

          # Wrapper: ensure LD_LIBRARY_PATH points to bundle libs
          cat > "$BIN/MP4Box" <<'SH'
          #!/usr/bin/env bash
          set -euo pipefail
          DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
          export LD_LIBRARY_PATH="$DIR/../lib:${LD_LIBRARY_PATH:-}"
          exec "$DIR/MP4Box.bin" "$@"
          SH
          chmod +x "$BIN/MP4Box"

          echo "::notice::Bundle built at $BUNDLE"
          echo "::group::Bundle tree"
          ls -la "$BIN"
          echo "--- lib (top) ---"
          ls -la "$LIB" | head -n 120 || true
          echo "--- lib/gpac (top) ---"
          ls -la "$LIB/gpac" 2>/dev/null | head -n 120 || true
          echo "::endgroup::"

      - name: Use MP4Box bundle (cache hit => no apt install)
        run: |
          set -euo pipefail

          BUNDLE_BIN="$HOME/.local/gpac-bundle/bin"

          echo "::notice::Activating bundle bin path: $BUNDLE_BIN"
          # $GITHUB_PATH affects subsequent steps only; export PATH for this step too.
          export PATH="$BUNDLE_BIN:$PATH"
          echo "$BUNDLE_BIN" >> "$GITHUB_PATH"

          echo "::group::Bundle sanity check"
          ls -la "$BUNDLE_BIN" || true
          echo "::endgroup::"

          command -v MP4Box
          MP4Box -version || true

      - name: Quick runtime check (ldd + run) - realistic env
        run: |
          set -euo pipefail

          BUNDLE="$HOME/.local/gpac-bundle"
          export LD_LIBRARY_PATH="$BUNDLE/lib:${LD_LIBRARY_PATH:-}"

          MP4="$(command -v MP4Box)"
          echo "MP4Box wrapper: $MP4"

          echo "::group::ldd MP4Box.bin (with LD_LIBRARY_PATH=$BUNDLE/lib)"
          ldd "$BUNDLE/bin/MP4Box.bin" | tee /tmp/ldd-mp4box.txt
          echo "::endgroup::"

          if grep -q "not found" /tmp/ldd-mp4box.txt; then
            echo "::error::ldd reported missing libraries (not found). Bundle is not self-contained."
            exit 1
          fi

          MP4Box -version || true

      - name: Upload gpac bundle artifact (optional)
        if: ${{ inputs.upload_bundle }}
        uses: actions/upload-artifact@v4
        with:
          name: gpac-bundle-${{ matrix.os }}-rev${{ inputs.bundle_rev }}
          path: ~/.local/gpac-bundle
          if-no-files-found: error
