name: Manzana Download (Apple TV+ Trailers)

# .github/workflows/manzana-download.yml @ v1.4.4
# - Improve trailer input description (avoid user confusion)
# - Add trailer input validation step (t<number> or all/a)
# - Keep everything else unchanged

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Apple TV URL (movie/show page)"
        required: true
        type: string
      trailer:
        description: 'Trailer selector: use t0, t1, t2... (e.g. "t0") or "all"'
        required: false
        default: "t0"
        type: string
      format:
        description: 'Optional. Format IDs like v0+a0+s4 (NOT "-F"). Leave empty to only list formats.'
        required: false
        default: ""
        type: string
      default_only:
        description: "Use --default (only default trailer metadata)"
        required: false
        default: false
        type: boolean

jobs:
  download:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate inputs
        run: |
          set -euo pipefail
          TRAILER="${{ inputs.trailer }}"
          if [[ -z "$TRAILER" ]]; then
            echo "::error::Input 'trailer' is empty. Use t0, t1, t2... or all."
            exit 1
          fi

          # allow: all / a / t<number>
          if [[ "$TRAILER" =~ ^(all|a|t[0-9]+)$ ]]; then
            echo "OK: trailer=$TRAILER"
          else
            echo "::error::Invalid trailer input: '$TRAILER'"
            echo "Expected: t0, t1, t2... (t + digits) OR 'all' (or 'a')."
            echo "Do NOT input: 't0 / t1 / all' or any text with spaces/slashes."
            exit 1
          fi

      - name: Phase 1 - List formats (-F) and save to formats.txt
        run: |
          if [ "${{ inputs.default_only }}" = "true" ]; then
            python manzana.py --default --no-prompt --trailer "${{ inputs.trailer }}" -F "${{ inputs.url }}" | tee formats.txt
          else
            python manzana.py --no-prompt --trailer "${{ inputs.trailer }}" -F "${{ inputs.url }}" | tee formats.txt
          fi

      - name: Upload formats as artifact (manzana-formats)
        uses: actions/upload-artifact@v4
        with:
          name: manzana-formats
          path: formats.txt
          if-no-files-found: error

      # -------- Phase 2 only (when format is provided) --------

      - name: Cache FFmpeg (BtbN)
        if: ${{ inputs.format != '' }}
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: ~/.local/ffmpeg-btbn
          key: ffmpeg-btbn-master-latest-linux64-gpl-v1

      - name: Install FFmpeg (BtbN Daily Build)
        if: ${{ inputs.format != '' && steps.cache-ffmpeg.outputs.cache-hit != 'true' }}
        run: |
          mkdir -p ~/.local/ffmpeg-btbn
          wget -O /tmp/ffmpeg.tar.xz https://github.com/BtbN/FFmpeg-Builds/releases/latest/download/ffmpeg-master-latest-linux64-gpl.tar.xz
          tar -xf /tmp/ffmpeg.tar.xz -C ~/.local/ffmpeg-btbn --strip-components=1
          ls -la ~/.local/ffmpeg-btbn/bin || true

      - name: Add FFmpeg to PATH
        if: ${{ inputs.format != '' }}
        run: |
          echo "$HOME/.local/ffmpeg-btbn/bin" >> $GITHUB_PATH

      - name: Verify FFmpeg in PATH
        if: ${{ inputs.format != '' }}
        run: |
          command -v ffmpeg
          ffmpeg -version | head -n 3
          command -v ffprobe
          ffprobe -version | head -n 3

      - name: Install MP4Box (gpac) [Phase 2 only]
        if: ${{ inputs.format != '' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gpac
          command -v MP4Box
          MP4Box -version || true

      - name: Phase 2 - Download (skip if format is empty)
        if: ${{ inputs.format != '' }}
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          if [ "${{ inputs.default_only }}" = "true" ]; then
            python manzana.py --default --no-prompt --trailer "${{ inputs.trailer }}" -f "${{ inputs.format }}" "${{ inputs.url }}"
          else
            python manzana.py --no-prompt --trailer "${{ inputs.trailer }}" -f "${{ inputs.format }}" "${{ inputs.url }}"
          fi

      - name: Inspect output media info (ffprobe summary + JSON)
        if: ${{ inputs.format != '' }}
        run: |
          mkdir -p report
          shopt -s nullglob
          files=(output/*.mp4)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No mp4 found in output/"
            exit 1
          fi

          for f in "${files[@]}"; do
            base="$(basename "$f")"
            echo "=== Inspecting: $base ==="

            echo "--- FORMAT (container) ---"
            ffprobe -hide_banner -v error \
              -show_entries format=filename,format_name,duration,size,bit_rate \
              -of default=nw=1 "$f"

            echo "--- STREAMS (tracks, includes bit_rate when available) ---"
            ffprobe -hide_banner -v error \
              -show_entries stream=index,codec_type,codec_name,profile,bit_rate,width,height,avg_frame_rate,channels,channel_layout,sample_rate:stream_tags=language,title \
              -of default=nw=1 "$f"

            echo "--- JSON (artifact) ---"
            ffprobe -hide_banner -v error \
              -show_format -show_streams \
              -print_format json "$f" > "report/${base}.ffprobe.json"
          done

      - name: Upload inspection report as artifact (manzana-report)
        if: ${{ inputs.format != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: manzana-report
          path: report/
          if-no-files-found: error

      - name: Upload output as artifact (manzana-output)
        if: ${{ inputs.format != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: manzana-output
          path: output/
          if-no-files-found: error
